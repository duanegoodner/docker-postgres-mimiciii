version: '3.8'

services:
  initialize_postgres_mimiciii:
    image: postgres_mimiciii
    build:
      context: ../
      dockerfile: ./db_setup/Dockerfile
      args:
        - PRIMARY_USER=gen_user
        - LOCAL_MIMICIII_BUILD_TOOLS=./vendor/mimic-code/mimic-iii/buildmimic
        - POSTGRES_ENTRYPOINT=/docker-entrypoint-initdb.d
    environment:
      - MIMIC_PASSWORD=mimic
      - BUILD_MIMIC=1
      - POSTGRES_PASSWORD=postgres
      - PGDATA=/var/lib/postgresql/data
    container_name: postgres_mimiciii_initialize
    volumes:
      - ${MIMICIII_CSV_DIR}:/mimic_data
      - postgres_mimiciii_data:/var/lib/postgresql/data
    ports:
      - 5555:5432
    init: true
    stdin_open: true
    tty: true

volumes:
  postgres_mimiciii_data:

  # Below code NOT needed when using Docker named volume

  # Use this service to ensure local user has access to locall mapped db files
  # See https://stackoverflow.com/a/75099809 for details
  # postgres_permissions:
  #   image: duanegoodner/postgres_mimiciii
  #   user: root
  #   volumes:
  #     - ${LOCAL_DB}:/var/lib/postgresql/data
  #   entrypoint:
  #     [
  #       "/bin/bash",
  #       "/docker-entrypoint-initdb.d/postgres_data_permissions/main.sh"
  #     ]
  #   depends_on:
  #     - postgres_mimiciii